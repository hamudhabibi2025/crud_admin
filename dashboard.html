<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Dashboard | ASKAB PSSI MENTAWAI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Gaya CSS dari respons sebelumnya */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #f0f4f7; }
        .header { background-color: #004d40; color: white; padding: 18px; text-align: center; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .main-container { display: flex; min-height: calc(100vh - 56px); }
        .sidebar { width: 250px; background-color: #263238; color: white; padding-top: 20px; box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1); }
        .sidebar a { padding: 15px 25px; text-decoration: none; font-size: 16px; color: white; display: block; border-bottom: 1px solid #37474f; transition: background-color 0.3s; }
        .sidebar a:hover, .sidebar a.active { background-color: #00897b; }
        .content { flex-grow: 1; padding: 30px; background-color: white; }
        #userInfo { margin-bottom: 25px; padding: 15px; background-color: #e0f2f1; border-left: 5px solid #004d40; border-radius: 4px; color: #333; }
        #userInfo strong { font-size: 1.1em; color: #004d40; }
        h2 { color: #004d40; border-bottom: 2px solid #e0f2f1; padding-bottom: 10px; margin-top: 0; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table th, .data-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .data-table th { background-color: #00897b; color: white; }
        .btn-crud { padding: 5px 10px; margin: 2px; border: none; cursor: pointer; border-radius: 3px; }
        .btn-edit { background-color: #ffc107; }
        .btn-delete { background-color: #dc3545; color: white; }
        .btn-disabled { background-color: #adb5bd; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="header">
    <h1>Dashboard ASKAB PSSI MENTAWAI</h1>
</div>

<div class="main-container">
    <div class="sidebar">
        <a href="#" id="menu-klub" onclick="loadContent('klub', this)">Data Klub</a>
        <a href="#" id="menu-team" onclick="loadContent('team', this)">Data Team</a>
        <a href="#" id="menu-berita" onclick="loadContent('berita', this)">Berita</a>
        <a href="#" onclick="logout()">Logout</a>
    </div>

    <div class="content">
        <div id="userInfo">Memuat informasi pengguna...</div>
        <div id="mainContent">
            <p>Pilih menu di navigasi kiri untuk melakukan operasi CRUD.</p>
        </div>
    </div>
</div>

<script>
    // ⚠️ GANTI DENGAN URL WEB APP ANDA YANG SUDAH DI-DEPLOY
    const APPS_SCRIPT_URL = 'GANTI_DENGAN_URL_DEPLOYMENT_APPS_SCRIPT_ANDA'; 

    window.onload = checkSession;
    let currentUserData = {};

    async function checkSession() {
        const token = localStorage.getItem('pssi_token');
        const userInfoDiv = document.getElementById('userInfo');

        if (!token) {
            alert('Anda harus login terlebih dahulu.');
            window.location.href = 'index.html'; 
            return;
        }

        try {
            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: 'validateSession', token: token })
            });

            const result = await response.json();

            if (!result.success) {
                alert('Sesi tidak valid atau telah berakhir. Silakan login kembali.');
                logout();
            } else {
                currentUserData = result.data; // Simpan data user
                localStorage.setItem('pssi_role', currentUserData.role);
                localStorage.setItem('pssi_id_klub', currentUserData.id_klub);

                userInfoDiv.innerHTML = `
                    Selamat Datang, <strong>${currentUserData.username}</strong><br>
                    Role: ${currentUserData.role}<br>
                    ID Klub: ${currentUserData.id_klub || 'N/A'}`;
            }

        } catch (error) {
            alert('Kesalahan koneksi saat validasi sesi.');
            logout();
        }
    }

    function logout() {
        const token = localStorage.getItem('pssi_token');
        if (token) {
             fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: 'logout', token: token })
            });
        }
        localStorage.clear();
        window.location.href = 'index.html'; 
    }

    async function loadContent(menu, element) {
        const contentDiv = document.getElementById('mainContent');
        const role = localStorage.getItem('pssi_role');
        
        document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
        element.classList.add('active');

        let sheetName = '';
        let requiredRoles = [];
        let keyColumn = '';

        if (menu === 'klub') {
            sheetName = 'login';
            requiredRoles = ['AdminPusat', 'AdminKlub'];
            keyColumn = 'id_klub';
        } else if (menu === 'team') {
            sheetName = 'datapemainofficial';
            requiredRoles = ['AdminPusat', 'AdminKlub'];
            keyColumn = 'id_team';
        } else if (menu === 'berita') {
            sheetName = 'beritapssimentawai';
            requiredRoles = ['AdminPusat', 'AdminEvent', 'AdminMedia'];
            keyColumn = 'tanggal'; // Menggunakan tanggal sebagai key sederhana
        }

        let html = `<h2>Data ${menu.toUpperCase()} (Sheet: ${sheetName})</h2>`;

        if (requiredRoles.includes(role)) {
            html += `<p>Anda memiliki akses sebagai **${role}**.</p>`;
            html += `<button class="btn-crud" style="background-color:#28a745; color:white;" onclick="doCrudOperation('${menu}', 'CREATE')">Tambah ${menu.toUpperCase()}</button>`;
            html += `<div id="dataGrid">Memuat data...</div>`;
            contentDiv.innerHTML = html;
            
            // Panggil fungsi untuk memuat data
            await fetchAndRenderData(sheetName, keyColumn);

        } else {
             html += `<p style="color:red; font-weight:bold;">Akses Ditolak. Role Anda (**${role}**) tidak diizinkan mengakses menu ini.</p>`;
             contentDiv.innerHTML = html;
        }
    }

    async function fetchAndRenderData(sheetName, keyColumn) {
        const token = localStorage.getItem('pssi_token');
        const dataGrid = document.getElementById('dataGrid');
        
        try {
            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ 
                    action: 'crud',
                    crudType: 'READ',
                    sheetName: sheetName,
                    token: token 
                })
            });
            const result = await response.json();

            if (result.success && result.data.length > 0) {
                renderTable(result.data, keyColumn, sheetName);
            } else {
                dataGrid.innerHTML = `<p style="color:orange;">Tidak ada data atau gagal memuat data: ${result.message}</p>`;
            }

        } catch (error) {
            dataGrid.innerHTML = `<p style="color:red;">Error koneksi saat mengambil data.</p>`;
            console.error(error);
        }
    }

    function renderTable(data, keyColumn, sheetName) {
        const dataGrid = document.getElementById('dataGrid');
        const headers = Object.keys(data[0]).filter(h => h !== 'is_locked' && h !== 'lock_reason');
        let tableHTML = '<table class="data-table"><thead><tr>';
        
        headers.forEach(h => tableHTML += `<th>${h.toUpperCase().replace(/_/g, ' ')}</th>`);
        tableHTML += '<th>Aksi</th></tr></thead><tbody>';

        data.forEach(row => {
            const isLocked = row.is_locked;
            tableHTML += '<tr>';
            headers.forEach(h => tableHTML += `<td>${row[h]}</td>`);
            
            // Tombol Aksi (Edit dan Delete)
            let actionButtons = '';
            const recordId = row[keyColumn]; // Gunakan nilai kolom kunci

            if (isLocked) {
                actionButtons += `<button class="btn-crud btn-disabled" title="Terkunci: ${row.lock_reason}">Edit (Locked)</button>`;
                actionButtons += `<button class="btn-crud btn-disabled" title="Terkunci: ${row.lock_reason}">Hapus (Locked)</button>`;
            } else {
                actionButtons += `<button class="btn-crud btn-edit" onclick="doCrudOperation('${sheetName}', 'UPDATE', '${recordId}')">Edit</button>`;
                actionButtons += `<button class="btn-crud btn-delete" onclick="doCrudOperation('${sheetName}', 'DELETE', '${recordId}')">Hapus</button>`;
            }

            tableHTML += `<td>${actionButtons}</td></tr>`;
        });

        tableHTML += '</tbody></table>';
        dataGrid.innerHTML = tableHTML;
    }

    function doCrudOperation(sheetName, crudType, recordId = null) {
        // Logika untuk mengirim permintaan UPDATE, CREATE, atau DELETE ke Apps Script
        alert(`Aksi ${crudType} pada ${sheetName} (ID: ${recordId || 'Baru'}) akan segera diimplementasikan. Backend sudah memiliki validasi lock!`);
        
        // Di sini Anda akan membuat formulir input data untuk CREATE/UPDATE, 
        // lalu mengirimkan payload menggunakan fetch() seperti pada fungsi checkSession().
    }
</script>

</body>
</html>
