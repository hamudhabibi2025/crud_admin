<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard PSM Mentawai</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; }
        .container { width: 95%; max-width: 1300px; margin: 20px auto; background-color: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); }
        h1, h2 { color: #333; border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-bottom: 25px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header button { padding: 10px 18px; background-color: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .header button:hover { background-color: #c82333; }
        #userInfo { font-size: 1.1em; color: #007bff; }
        
        /* Formulir */
        #dataForm { background-color: #f8f9fa; padding: 25px; border-radius: 8px; margin-bottom: 30px; border: 1px solid #e9ecef;}
        #dataForm input, #dataForm select { padding: 10px; margin-bottom: 12px; border: 1px solid #ced4da; border-radius: 4px; display: block; width: 100%; box-sizing: border-box; }
        #formButtons { display: flex; gap: 10px; margin-top: 15px; }
        #submitBtn { background-color: #28a745; }
        #submitBtn:hover { background-color: #1e7e34; }
        #cancelBtn { background-color: #6c757d; }
        #cancelBtn:hover { background-color: #5a6268; }

        /* Tabel */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; min-width: 800px; }
        th, td { border: 1px solid #dee2e6; padding: 10px; text-align: left; font-size: 13px; vertical-align: middle; }
        th { background-color: #007bff; color: white; position: sticky; top: 0; }
        .btn-action { border: none; padding: 6px 10px; cursor: pointer; border-radius: 3px; margin-right: 5px; font-size: 12px; }
        .btn-edit { background-color: #ffc107; color: #333; }
        .btn-delete { background-color: #dc3545; color: white; }
        .btn-action:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Message */
        #messageCrud { margin-top: 20px; padding: 12px; border-radius: 4px; font-weight: bold; display: none; text-align: center; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Dashboard Klub</h1>
            <div id="userInfo"></div>
            <button onclick="handleLogout()">Logout</button>
        </div>

        <h2>Input Data Pemain/Official</h2>
        <form id="dataForm" data-mode="CREATE" data-sheet-name="team">
            <input type="text" id="id_team" name="id_team" placeholder="ID Team (16 Digit Angka)" pattern="\d{16}" title="Harus 16 digit angka" required>
            <input type="text" id="nama_lengkap_team" name="nama_lengkap_team" placeholder="Nama Lengkap" required>
            <input type="date" id="tanggal_lahir_team" name="tanggal_lahir_team" placeholder="Tanggal Lahir" required>
            <select id="posisi_team" name="posisi_team" required>
                <option value="">Pilih Posisi (Pemain/Official)</option>
                <option value="Pemain">Pemain</option>
                <option value="Official">Official</option>
            </select>
            <input type="text" id="photo_url_team" name="photo_url_team" placeholder="URL Photo Team" required>
            <input type="number" id="no_punggung_team" name="no_punggung_team" placeholder="No Punggung (Jika Pemain)" min="0">

            <div id="formButtons">
                <button type="submit" id="submitBtn">Tambah Data</button>
                <button type="button" onclick="resetForm()" id="cancelBtn">Batal/Reset</button>
            </div>
        </form>
        <div id="messageCrud"></div>

        <h2>Data Pemain/Official Klub Anda</h2>
        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>ID Team</th>
                        <th>Nama Lengkap</th>
                        <th>Usia</th>
                        <th>Posisi</th>
                        <th>Photo</th>
                        <th>Status Persetujuan</th>
                        <th>Dibuat Pada</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <tr><td colspan="8">Harap login untuk melihat data.</td></tr>
                </tbody>
            </table>
        </div>

    </div>

    <script>
        // *** GANTI URL INI DENGAN LINK DEPLOYMENT APPS SCRIPT TERBARU ANDA ***
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyopTiBS76aCj-o_tJhDZ6M4-4y9bGPnpdxVMnOAo6BP21271kGgbMiHUZGhWZtliR3/exec';
        // *******************************************************************

        const submitBtn = document.getElementById('submitBtn');
        const form = document.getElementById('dataForm');
        const messageCrudDiv = document.getElementById('messageCrud');
        const teamPrimaryKey = 'id_team'; // Kunci utama untuk data Team

        // =================================================================
        // UTILITY
        // =================================================================

        function displayCrudMessage(text, isSuccess) {
            messageCrudDiv.textContent = text;
            messageCrudDiv.className = isSuccess ? 'success' : 'error';
            messageCrudDiv.style.display = 'block';
            setTimeout(() => { messageCrudDiv.style.display = 'none'; }, 5000);
        }

        function handleLogout() {
            const token = localStorage.getItem('userToken');
            
            if (token) {
                 // Kirim permintaan logout ke backend (opsional, untuk menghapus sesi di sheet)
                 fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'logout', token: token })
                 }).catch(e => console.error("Logout request failed:", e));
            }
            
            localStorage.clear();
            window.location.href = 'index.html';
        }

        // =================================================================
        // SESI & VALIDASI
        // =================================================================

        async function validateSession() {
            const token = localStorage.getItem('userToken');
            if (!token) {
                window.location.href = 'index.html';
                return;
            }

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'validateSession', token: token })
                });

                const result = await response.json();
                if (!result.success) {
                    alert('Sesi habis atau tidak valid. Silakan login ulang.');
                    handleLogout();
                    return;
                }
                
                const user = result.data;
                const infoText = `${user.role} | Klub: ${user.nama_klub} (${user.id_klub})`;
                document.getElementById('userInfo').textContent = infoText;

                // Setelah validasi, muat data
                loadData(form.dataset.sheetName); 

            } catch (error) {
                console.error('Validation Error:', error);
                alert('Gagal terhubung ke server. Coba lagi.');
                // Jika koneksi gagal, jangan log out tapi tampilkan error
            }
        }

        // =================================================================
        // CRUD IMPLEMENTATION
        // =================================================================
        
        async function loadData(sheetName) {
            const token = localStorage.getItem('userToken');
            const tableBody = document.getElementById('dataTableBody'); 
            tableBody.innerHTML = '<tr><td colspan="8">Memuat data...</td></tr>';

            const data = {
                action: 'crud',
                crudType: 'READ',
                sheetName: sheetName,
                token: token
            };

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    renderTable(result.data, sheetName);
                } else {
                    tableBody.innerHTML = `<tr><td colspan="8" style="color: red;">Gagal memuat data: ${result.message}</td></tr>`;
                    if (response.status === 401) handleLogout();
                }
            } catch (error) {
                console.error('Error saat memuat data:', error);
                tableBody.innerHTML = `<tr><td colspan="8" style="color: red;">Kesalahan Koneksi Jaringan.</td></tr>`;
            }
        }

        function renderTable(dataArray, sheetName) {
            const tableBody = document.getElementById('dataTableBody');
            tableBody.innerHTML = ''; 

            if (dataArray.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8">Tidak ada data ditemukan.</td></tr>';
                return;
            }

            dataArray.forEach(item => {
                const row = tableBody.insertRow();
                const pk = item[teamPrimaryKey]; // id_team

                const displayKeys = [
                    teamPrimaryKey, 
                    'nama_lengkap_team', 
                    'usia_team', 
                    'posisi_team',
                    'photo_url_team_display', // Menggunakan kolom HTML yang dibuat di Code.gs
                    'Status_Persetujuan',
                    'timecreated',
                ];

                displayKeys.forEach(key => {
                    const cell = row.insertCell();
                    
                    if (key.endsWith('_display')) {
                        cell.innerHTML = item[key] || 'N/A';
                    } else if (key === 'timecreated') {
                         const date = new Date(item[key]);
                         cell.textContent = date.toLocaleDateString('id-ID') + ' ' + date.toLocaleTimeString('id-ID');
                    } else {
                        cell.textContent = item[key];
                    }
                });

                const actionCell = row.insertCell();
                
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Edit';
                editBtn.className = 'btn-action btn-edit';
                editBtn.onclick = () => loadRecordForEdit(pk, sheetName); 
                
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Hapus';
                deleteBtn.className = 'btn-action btn-delete';
                deleteBtn.onclick = () => {
                    if (confirm(`Yakin ingin menghapus data ID: ${pk}?`)) {
                        handleDelete(pk, sheetName);
                    }
                };

                // Kunci tombol berdasarkan status dari backend
                if (item.is_locked) {
                    editBtn.disabled = true;
                    editBtn.title = `Terkunci: ${item.lock_reason}`;
                    deleteBtn.disabled = true;
                    deleteBtn.title = `Terkunci: ${item.lock_reason}`;
                }
                
                actionCell.appendChild(editBtn);
                actionCell.appendChild(deleteBtn);
            });
        }

        async function loadRecordForEdit(recordId, sheetName) {
            const token = localStorage.getItem('userToken');
            const data = {
                action: 'crud',
                crudType: 'READ_BY_ID',
                sheetName: sheetName,
                recordId: recordId,
                token: token
            };
            
            displayCrudMessage('Memuat data untuk diedit...', true);

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    fillFormForEdit(result.data);
                    displayCrudMessage('Data siap diedit. ID Team dikunci.', true);
                } else {
                    displayCrudMessage('Gagal memuat data untuk edit: ' + result.message, false);
                }
            } catch (error) {
                console.error('Error saat memuat data edit:', error);
                displayCrudMessage('Kesalahan Koneksi saat memuat data edit.', false);
            }
        }

        function fillFormForEdit(data) {
            form.dataset.mode = 'UPDATE';
            form.dataset.recordId = data[teamPrimaryKey];
            submitBtn.textContent = 'Update Data';
            
            for (const key in data) {
                const input = document.getElementById(key);
                if (input) {
                    if (key === teamPrimaryKey) {
                        input.disabled = true; // Kunci ID saat update
                    }
                    input.value = data[key];
                }
            }
            
            form.scrollIntoView({ behavior: 'smooth' }); 
        }
        
        function resetForm() {
            form.reset();
            form.dataset.mode = 'CREATE';
            form.dataset.recordId = '';
            submitBtn.textContent = 'Tambah Data';
            document.getElementById(teamPrimaryKey).disabled = false;
        }

        async function handleDelete(recordId, sheetName) {
            const token = localStorage.getItem('userToken');
            const data = {
                action: 'crud',
                crudType: 'DELETE',
                sheetName: sheetName,
                recordId: recordId,
                token: token
            };

            displayCrudMessage('Menghapus data...', false);

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    displayCrudMessage(result.message, true);
                    loadData(sheetName); 
                } else {
                    displayCrudMessage('Gagal menghapus data: ' + result.message, false);
                }
            } catch (error) {
                console.error('Error saat menghapus data:', error);
                displayCrudMessage('Kesalahan Koneksi saat menghapus data.', false);
            }
        }

        async function handleSubmit(event) {
            event.preventDefault();
            
            const crudMode = form.dataset.mode;
            const recordId = form.dataset.recordId;
            const sheetName = form.dataset.sheetName;
            const token = localStorage.getItem('userToken');
            
            let payload = {};
            const formData = new FormData(form);
            
            formData.forEach((value, key) => {
                 const inputElement = document.getElementById(key);
                 // Hanya kirim input yang tidak disabled
                 if (inputElement && !inputElement.disabled) {
                     payload[key] = value;
                 }
            });

            if (crudMode === 'UPDATE' && !recordId) {
                displayCrudMessage('Gagal UPDATE: ID record hilang.', false);
                return;
            }

            const data = {
                action: 'crud',
                crudType: crudMode, 
                sheetName: sheetName,
                recordId: crudMode === 'UPDATE' ? recordId : undefined,
                payload: payload,
                token: token
            };

            displayCrudMessage(`${crudMode === 'CREATE' ? 'Menambah' : 'Memperbarui'} data...`, true);

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    displayCrudMessage(result.message, true);
                    resetForm();
                    loadData(sheetName); 
                } else {
                    displayCrudMessage('Gagal: ' + result.message, false);
                }
            } catch (error) {
                console.error('Error Submit:', error);
                displayCrudMessage('Kesalahan koneksi saat mengirim data.', false);
            }
        }

        // =================================================================
        // INISIALISASI
        // =================================================================
        form.addEventListener('submit', handleSubmit);
        validateSession();
    </script>
</body>
</html>
